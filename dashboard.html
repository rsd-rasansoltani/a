<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§Ø³Ø§Ù† Ø¯ÛŒØ²Ø§ÛŒÙ†</title>
  <style>
    * { font-family: 'Vazirmatn', sans-serif; }
    body { margin: 0; padding: 0; background: #f0f0f0; }
    header {
      background: #0d6efd; color: white; padding: 20px; text-align: center;
      position: relative;
    }
    .container { padding: 20px; max-width: 800px; margin: auto; }
    .card {
      background: white; padding: 20px; border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn-main {
      background: #198754; color: white; border: none;
      padding: 10px 20px; border-radius: 8px; cursor: pointer;
    }
    .logout-btn {
      background: #dc3545; color: white; padding: 10px 20px;
      border: none; border-radius: 10px; cursor: pointer; float: left;
    }
    .service-menu { display: none; margin-top: 20px; }
    .service-menu button {
      display: block; width: 100%; margin: 5px 0; padding: 10px;
      background: #6c757d; color: white; border: none; border-radius: 6px;
    }
    #project-form { display: none; margin-top: 20px; }
    input, textarea {
      width: 100%; margin: 10px 0; padding: 8px; border-radius: 6px;
      border: 1px solid #ccc;
    }
    .signature {
      border: 1px dashed #aaa; padding: 10px; text-align: center;
      margin-top: 15px;
    }
    canvas {
      border: 1px dashed #ccc;
      width: 100%; height: 200px; background-color: #f9f9f9;
    }
    .projects-list { margin-top: 20px; }
    .project-item { background: #e9ecef; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‰ Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§Ø³Ø§Ù† Ø¯ÛŒØ²Ø§ÛŒÙ†</h1>
    <h2>Ø­ØªÙ…Ø§ Ùˆ Ø­ØªÙ…Ø§ VPN Ø±ÙˆØ´Ù† Ø¨Ø§Ø´Ø¯</h2>
  </header>

  <div class="container">
    <div class="card">
      <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
      <h2 id="welcome-msg">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</h2>
      <button class="btn-main" onclick="toggleServiceMenu()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡</button>

      <div class="service-menu" id="service-menu">
        <button onclick="selectService('Ø³Ø§Ø®Øª ÙˆØ¨')">Ø³Ø§Ø®Øª ÙˆØ¨</button>
        <button onclick="selectService('Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡')">Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
        <button onclick="selectService('Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ÛŒ')">Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ÛŒ</button>
        <button onclick="selectService('Ø³Ø§Ø®Øª DNS Ø¨Ø§Ø²ÛŒ')">Ø³Ø§Ø®Øª DNS Ø¨Ø§Ø²ÛŒ</button>
        <button onclick="selectService('Ø³Ø§Ø®Øª Ø¹Ú©Ø³ Ùˆ Ù„ÙˆÚ¯Ùˆ')">Ø³Ø§Ø®Øª Ø¹Ú©Ø³ Ùˆ Ù„ÙˆÚ¯Ùˆ</button>
        <button onclick="selectService('Ø§Ø¯ÛŒØª Ùˆ ÙØªÙˆØ´Ø§Ù¾')">Ø§Ø¯ÛŒØª Ùˆ ÙØªÙˆØ´Ø§Ù¾</button>
      </div>

      <div id="project-form">
        <h3>ÙØ±Ù… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
        <input type="text" id="firstName" placeholder="Ù†Ø§Ù…">
        <input type="text" id="lastName" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
        <input type="text" id="nationalCode" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ">
        <input type="text" id="birthDate" placeholder="ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ù…Ø«Ù„Ø§Ù‹ 1380/01/01)">
        <input type="text" id="phoneNumber" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">

        <textarea id="contract" rows="10" placeholder="Ù…ØªÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯..." readonly></textarea>
        
        <!-- Ø§Ù…Ø¶Ø§ -->
        <div class="signature">
          Ø§Ù…Ø¶Ø§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†:
          <canvas id="signature-pad" width="400" height="200"></canvas>
          <br/>
          <button onclick="clearSignature()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§</button>
        </div>

        <button class="btn-main" onclick="submitProject()">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø±ÙˆÚ˜Ù‡</button>
      </div>

      <div class="projects-list" id="projects-list">
        <h3>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ:</h3>
        <div id="projects"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_Zyp4-it4jqoDDKoHQYkJZcW6wpgzNIw",
      authDomain: "rasandesign-c13b0.firebaseapp.com",
      projectId: "rasandesign-c13b0",
      storageBucket: "rasandesign-c13b0.appspot.com",
      messagingSenderId: "1062175326327",
      appId: "1:1062175326327:web:ab5c3e2b3b64b7b43a9060"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const botToken = "7851763243:AAEKxm55yC3PelOQKsDl3tD_LRVkbzN1ggk";
    const chatId = "7650517255";
    let signaturePad = new SignaturePad(document.getElementById('signature-pad'));

    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById("welcome-msg").innerText = `Ø³Ù„Ø§Ù… ${user.email} ğŸ‘‹ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!`;
        loadProjects(user.uid);  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡
      } else {
        window.location.href = "login.html";
      }
    });

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }

    function toggleServiceMenu() {
      const menu = document.getElementById("service-menu");
      menu.style.display = menu.style.display === "none" ? "block" : "none";
    }

    function selectService(service) {
      document.getElementById("project-form").style.display = "block";
      document.getElementById("contract").value = `Ø§ÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® ... Ø¨ÛŒÙ† Ø´Ø±Ú©Øª Ø±Ø§Ø³Ø§Ù† Ø¯ÛŒØ²Ø§ÛŒÙ† Ùˆ ... Ù…Ù†Ø¹Ù‚Ø¯ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.\nÙ…ÙˆØ¶ÙˆØ¹: ${service}\n(Û±. Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙˆØ³Ø· Ù…Ø´ØªØ±ÛŒ ÛŒØ§ Ø¹Ø¯Ù… Ù¾ÛŒØ´Ø±ÙØª Ù¾Ø±ÙˆÚ˜Ù‡ØŒ Ú©Ø§Ø±ÙØ±Ù…Ø§ Ø­Ù‚ ÙØ³Ø® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯.
Û². Ù…Ø´ØªØ±ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ù¾ÛŒØ´Ø±ÙØª Ù¾Ø±ÙˆÚ˜Ù‡ØŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø±Ø§ ÙØ³Ø® Ù†Ù…Ø§ÛŒØ¯ØŒ Ù…Ø´Ø±ÙˆØ· Ø¨Ø± Ø§ÛŒÙ†Ú©Ù‡ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±ÙØ±Ù…Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ú¯Ø±Ø¯Ø¯.

Ø§ÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª Ø¬Ù‡Øª Ú©Ø§Ù…Ù„ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ±Ù… Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± Ø³Ø±ÛŒØ¹ ØªØ±ÛŒÙ† Ø­Ø§Ù„Øª Ù…Ù…Ú©Ù† Ù¾ÛŒØ§Ù… Ø¯Ù‡ÛŒÙ…)`;
    }

    function submitProject() {
      const user = firebase.auth().currentUser;
      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const nationalCode = document.getElementById("nationalCode").value;
      const birthDate = document.getElementById("birthDate").value;
      const phoneNumber = document.getElementById("phoneNumber").value;
      const contract = document.getElementById("contract").value;

      if (!firstName || !lastName || !nationalCode || !birthDate || !phoneNumber || signaturePad.isEmpty()) {
        alert("Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.");
        return;
      }

      const signature = signaturePad.toDataURL(); // Get the signature in base64 format

      // Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø± Firestore
      const service = document.querySelector(".service-menu button.active")?.innerText || 'Ù†Ø§Ù…Ø´Ø®Øµ';
      const projectData = {
        firstName,
        lastName,
        nationalCode,
        birthDate,
        phoneNumber,
        contract,
        signature,
        service,
        userId: user.uid, // Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ
        date: firebase.firestore.FieldValue.serverTimestamp(),
      };

      db.collection("projects").add(projectData).then((docRef) => {
        const projectLink = `https://rasandesign-c13b0.web.app/projects/${docRef.id}`; // Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÚ˜Ù‡

        const message = `ğŸ“ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯:\nğŸ“ Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÚ˜Ù‡: ${projectLink}`;

        // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
        fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: chatId,
            text: message,
            parse_mode: "HTML" // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØµÙˆØ±Øª HTML
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            alert("âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ùˆ ... Ø¨Ù‡ Ø´Ù…Ø§ Ù¾ÛŒØ§Ù… Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø§Ø¯!");
            loadProjects(user.uid);  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øª
          } else {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…:", data.error_code, data.description);
            alert("âŒØ®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… .");
          }
        })
        .catch(error => {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:', error);
          alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù….");
        });
      }).catch((error) => {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡:", error);
        alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡.");
      });
    }

    function loadProjects(userId) {
      const projectsDiv = document.getElementById("projects");
      projectsDiv.innerHTML = ''; // Clear previous projects

      db.collection("projects").where("userId", "==", userId).get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const project = doc.data();
          const projectElement = document.createElement("div");
          projectElement.classList.add("project-item");
          projectElement.innerHTML = `Ù¾Ø±ÙˆÚ˜Ù‡: ${project.service} | ${project.firstName} ${project.lastName}`;
          projectsDiv.appendChild(projectElement);
        });
      });
    }

    function clearSignature() {
      signaturePad.clear(); // Clear the signature pad
    }
  </script>
</body>
</html>
